<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada Coin - Transferencias</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #3b82f6;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --gold-color: #fbbf24;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .banking-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .banking-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            min-height: calc(100vh - 200px);
            overflow: hidden;
        }
        
        .banking-tab {
            position: relative;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #4b5563;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .banking-tab:hover {
            color: var(--primary-color);
            background: rgba(30, 64, 175, 0.05);
        }
        
        .banking-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: linear-gradient(to bottom, rgba(30, 64, 175, 0.1), transparent);
        }
        
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 1rem;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #4b5563;
            transition: background 0.3s ease;
        }
        
        .dropdown-item:hover {
            background: #f9fafb;
        }
        
        .transfer-item {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            transition: background 0.3s ease;
        }
        
        .transfer-item:hover {
            background: #f8fafc;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 18px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Notificaciones -->
    <div id="notifications-container"></div>
    
    <!-- Modal de Buscar Usuario -->
    <div id="search-user-modal" class="modal">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Buscar Usuario</h3>
                <button id="close-search-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Correo electrónico del usuario</label>
                    <input type="email" id="search-user-email" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="correo@ejemplo.com">
                </div>
                
                <div id="search-results" class="hidden">
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-medium text-gray-900 mb-3">Resultado de búsqueda:</h4>
                        
                        <!-- Loading Spinner -->
                        <div id="search-loading" class="hidden">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-center text-gray-600">Buscando usuario...</p>
                        </div>
                        
                        <div id="user-found" class="p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <p id="found-user-name" class="font-bold text-gray-900">Nombre del usuario</p>
                                    <p id="found-user-email" class="text-sm text-gray-600">usuario@email.com</p>
                                </div>
                            </div>
                            <button id="use-this-user" class="w-full mt-4 bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700">
                                Usar este usuario
                            </button>
                        </div>
                        
                        <div id="user-not-found" class="p-4 bg-red-50 border border-red-200 rounded-lg text-center hidden">
                            <i class="fas fa-user-slash text-3xl text-red-500 mb-3"></i>
                            <p class="text-gray-700">No se encontró ningún usuario con este correo electrónico</p>
                            <p class="text-sm text-gray-600 mt-2">Solo puedes transferir a usuarios registrados en Canada Coin</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancel-search" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="search-user-button-modal" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold px-6 py-2 rounded-lg hover:opacity-90">
                        Buscar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Header Superior -->
    <header class="banking-header sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Primera fila: Logo y usuario -->
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-coins text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Canada Coin</h1>
                            <p class="text-xs text-gray-500">Banca Digital</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Perfil de usuario -->
                    <div class="relative">
                        <button id="user-profile-button" 
                                class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 transition">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div class="hidden md:block text-left">
                                <p id="user-name" class="font-semibold text-gray-900">Usuario</p>
                                <p class="text-xs text-gray-500">Ver perfil</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-500 text-sm"></i>
                        </button>
                        
                        <!-- Dropdown usuario -->
                        <div id="user-profile-dropdown" class="dropdown-menu">
                            <div class="p-4 border-b border-gray-200">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-white text-lg"></i>
                                    </div>
                                    <div>
                                        <p id="dropdown-user-name" class="font-bold text-gray-900">Usuario</p>
                                        <p id="dropdown-user-email" class="text-sm text-gray-500">usuario@email.com</p>
                                    </div>
                                </div>
                            </div>
                            <div class="py-2">
                                <a href="profile.html" class="dropdown-item">
                                    <i class="fas fa-user text-gray-400 w-6"></i>
                                    Mi Perfil
                                </a>
                                <a href="security.html" class="dropdown-item">
                                    <i class="fas fa-shield-alt text-gray-400 w-6"></i>
                                    Seguridad
                                </a>
                                <a href="settings.html" class="dropdown-item">
                                    <i class="fas fa-cog text-gray-400 w-6"></i>
                                    Configuración
                                </a>
                                <hr class="my-2">
                                <a href="#" id="logout-button" class="dropdown-item text-red-600">
                                    <i class="fas fa-sign-out-alt text-red-400 w-6"></i>
                                    Cerrar Sesión
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Segunda fila: Navegación por pestañas -->
            <div class="border-t border-gray-200">
                <nav class="flex overflow-x-auto">
                    <a href="index.html" class="banking-tab">
                        <i class="fas fa-home mr-2"></i>Resumen
                    </a>
                    <a href="investments.html" class="banking-tab">
                        <i class="fas fa-chart-line mr-2"></i>Inversiones
                    </a>
                    <a href="deposits.html" class="banking-tab">
                        <i class="fas fa-arrow-up mr-2"></i>Depósitos
                    </a>
                    <a href="withdrawals.html" class="banking-tab">
                        <i class="fas fa-arrow-down mr-2"></i>Retiros
                    </a>
                    <a href="transfers.html" class="banking-tab active">
                        <i class="fas fa-exchange-alt mr-2"></i>Transferencias
                    </a>
                    <a href="cards.html" class="banking-tab">
                        <i class="fas fa-credit-card mr-2"></i>Tarjetas
                    </a>
                    <a href="referrals.html" class="banking-tab">
                        <i class="fas fa-users mr-2"></i>Referidos
                    </a>
                    <a href="support.html" class="banking-tab">
                        <i class="fas fa-headset mr-2"></i>Soporte
                    </a>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="banking-content">
            <!-- Pestaña: Transferencias -->
            <div class="p-6">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Transferencias</h2>
                    <p class="text-gray-600">Envía dinero de forma segura a otros usuarios de Canada Coin</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <!-- Nueva Transferencia -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-6">Nueva Transferencia</h3>
                            <form id="transfer-form">
                                <div class="space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
                                            <div class="relative">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <span class="text-gray-500">$</span>
                                                </div>
                                                <input type="number" id="transfer-amount" 
                                                       class="pl-8 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                       placeholder="0.00" min="1" required>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Comisión: $0.50</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Moneda</label>
                                            <select id="transfer-currency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                <option value="USD">USD</option>
                                                <option value="EUR">EUR</option>
                                                <option value="CAD">CAD</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Destinatario</label>
                                        <div class="space-y-3">
                                            <div id="selected-recipient" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                                <div class="flex justify-between items-center">
                                                    <div class="flex items-center">
                                                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-white"></i>
                                                        </div>
                                                        <div>
                                                            <p id="recipient-display-name" class="font-bold text-gray-900">Nombre del usuario</p>
                                                            <p id="recipient-display-email" class="text-sm text-gray-600">usuario@email.com</p>
                                                        </div>
                                                    </div>
                                                    <button type="button" id="change-recipient" class="text-blue-600 hover:text-blue-800">
                                                        Cambiar
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div id="select-recipient" class="space-y-3">
                                                <div class="flex space-x-2">
                                                    <select id="transfer-recipient" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                                        <option value="">Seleccionar contacto</option>
                                                        <!-- Los contactos se cargarán dinámicamente -->
                                                    </select>
                                                    <button type="button" id="search-user-button" class="px-4 py-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                                <p class="text-sm text-gray-500">Solo puedes transferir a usuarios registrados en Canada Coin</p>
                                            </div>
                                            
                                            <input type="hidden" id="recipient-id">
                                            <input type="hidden" id="recipient-email">
                                            <input type="hidden" id="recipient-name">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje (opcional)</label>
                                        <textarea id="transfer-message" 
                                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                  rows="3" placeholder="Agregar nota..."></textarea>
                                    </div>
                                    
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h4 class="font-medium text-blue-800 mb-2">Resumen de Transferencia</h4>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Monto a transferir:</span>
                                                <span id="transfer-summary-amount" class="font-bold">$0.00</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Comisión:</span>
                                                <span id="transfer-summary-fee" class="font-bold text-red-600">-$0.50</span>
                                            </div>
                                            <div class="flex justify-between pt-2 border-t border-blue-200">
                                                <span class="font-medium text-blue-800">Total a deducir:</span>
                                                <span id="transfer-summary-total" class="font-bold text-red-600">$0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" id="transfer-submit-button"
                                                class="bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold px-8 py-3 rounded-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
                                                disabled>
                                            Realizar Transferencia
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Historial -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-bold text-gray-900">Historial de Transferencias</h3>
                            </div>
                            <div id="transfers-history" class="divide-y divide-gray-100">
                                <div class="text-center py-12">
                                    <i class="fas fa-exchange-alt text-4xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500">No hay transferencias registradas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <!-- Contactos Frecuentes -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-6">Contactos Frecuentes</h3>
                            <div id="contacts-list" class="space-y-4">
                                <div class="text-center py-8">
                                    <i class="fas fa-users text-3xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500">No tienes contactos guardados</p>
                                </div>
                            </div>
                            <button id="add-new-contact" class="w-full mt-4 border-2 border-dashed border-gray-300 rounded-lg py-3 text-gray-500 hover:border-blue-500 hover:text-blue-500">
                                <i class="fas fa-search mr-2"></i>Buscar Usuario
                            </button>
                        </div>
                        
                        <!-- Información -->
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl p-6 text-white">
                            <h3 class="text-lg font-bold mb-4">Transferencias Seguras</h3>
                            <p class="text-sm mb-2">Envíos seguros entre usuarios de Canada Coin</p>
                            <ul class="text-sm space-y-1 mb-4">
                                <li><i class="fas fa-check mr-2"></i>Solo usuarios verificados</li>
                                <li><i class="fas fa-check mr-2"></i>Comisión fija $0.50</li>
                                <li><i class="fas fa-check mr-2"></i>Procesamiento inmediato</li>
                                <li><i class="fas fa-check mr-2"></i>Seguridad garantizada</li>
                            </ul>
                            <div class="text-xs opacity-80">
                                <p><i class="fas fa-info-circle mr-1"></i> Las transferencias solo están disponibles para usuarios registrados en Canada Coin</p>
                            </div>
                        </div>
                        
                        <!-- Límites de Transferencia -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6 mt-6">
                            <h3 class="text-lg font-bold text-gray-900 mb-6">Límites</h3>
                            <div class="space-y-6">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">Diario</span>
                                        <span class="font-medium">$0 / $5,000</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-600">Mensual</span>
                                        <span class="font-medium">$0 / $20,000</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button class="text-blue-600 font-medium hover:text-blue-800">
                                        Aumentar Límites
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBI4O0d_Mec38FDiuhirujCnX99PFKiXW4",
            authDomain: "projekt-pc.firebaseapp.com",
            databaseURL: "https://projekt-pc-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "projekt-pc",
            storageBucket: "projekt-pc.appspot.com",
            messagingSenderId: "90098431634",
            appId: "1:90098431634:web:7cb61800d03533c2a6984b",
            measurementId: "G-59YH8W8W1L"
        };

        firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const db = firebase.database();

        // Initialize Application
        document.addEventListener('DOMContentLoaded', initTransfers);
        
        function initTransfers() {
            // Check authentication
            auth.onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    loadUserData(user.uid);
                    setupEventListeners();
                    loadTransfersHistory(user.uid);
                    loadContacts(user.uid);
                }
            });
        }
        
        function loadUserData(userId) {
            const userRef = db.ref('users/' + userId);
            
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUserInfo(data);
                }
            });
        }
        
        function updateUserInfo(userData) {
            document.getElementById('user-name').textContent = userData.name || 'Usuario';
            document.getElementById('dropdown-user-name').textContent = userData.name || 'Usuario';
            document.getElementById('dropdown-user-email').textContent = userData.email || 'usuario@email.com';
        }
        
        function loadTransfersHistory(userId) {
            const transfersRef = db.ref('transfers/' + userId);
            
            transfersRef.orderByChild('createdAt').limitToLast(10).on('value', (snapshot) => {
                const transfers = [];
                snapshot.forEach((childSnapshot) => {
                    transfers.unshift({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                
                updateTransfersHistory(transfers);
            });
        }
        
        function updateTransfersHistory(transfers) {
            const container = document.getElementById('transfers-history');
            
            if (!transfers.length) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exchange-alt text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No hay transferencias registradas</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transfers.forEach(transfer => {
                const date = new Date(transfer.createdAt);
                const isOutgoing = transfer.type === 'sent';
                const iconClass = isOutgoing ? 'fa-arrow-up text-red-600 bg-red-100' : 'fa-arrow-down text-green-600 bg-green-100';
                
                html += `
                    <div class="transfer-item">
                        <div class="transaction-icon ${iconClass.split(' ')[2]}">
                            <i class="fas ${iconClass.split(' ')[0]}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium">${transfer.description || (isOutgoing ? 'Transferencia enviada' : 'Transferencia recibida')}</p>
                                    <p class="text-sm text-gray-500">
                                        ${isOutgoing ? 'A: ' : 'De: '}${transfer.recipientName || transfer.senderName || 'Usuario'}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold ${isOutgoing ? 'text-red-600' : 'text-green-600'}">
                                        ${isOutgoing ? '-' : '+'}$${transfer.amount?.toFixed(2) || '0.00'}
                                    </p>
                                    <p class="text-xs text-gray-500">${date.toLocaleDateString('es-ES')}</p>
                                </div>
                            </div>
                            ${transfer.message ? `<p class="text-sm text-gray-600 mt-1">"${transfer.message}"</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function loadContacts(userId) {
            const contactsRef = db.ref('contacts/' + userId);
            
            contactsRef.on('value', (snapshot) => {
                const contacts = [];
                snapshot.forEach((childSnapshot) => {
                    const contact = childSnapshot.val();
                    // Solo mostrar contactos que son usuarios registrados (tienen userId)
                    if (contact.userId && contact.userId !== userId) {
                        contacts.push({ id: childSnapshot.key, ...contact });
                    }
                });
                
                updateContactsList(contacts);
                updateRecipientSelect(contacts);
            });
        }
        
        function updateContactsList(contacts) {
            const container = document.getElementById('contacts-list');
            
            if (!contacts.length) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-users text-3xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No tienes contactos guardados</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            contacts.forEach(contact => {
                html += `
                    <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer contact-item" data-id="${contact.id}" data-userid="${contact.userId}" data-email="${contact.email}" data-name="${contact.name}">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium">${contact.name}</p>
                            <p class="text-sm text-gray-500">${contact.email}</p>
                        </div>
                        <button class="text-gray-400 hover:text-red-600 delete-contact" data-id="${contact.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add event listeners for contact selection and deletion
            document.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-contact')) {
                        const userId = item.getAttribute('data-userid');
                        const email = item.getAttribute('data-email');
                        const name = item.getAttribute('data-name');
                        
                        if (userId) {
                            selectContact(userId, email, name);
                        }
                    }
                });
            });
            
            document.querySelectorAll('.delete-contact').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const contactId = button.getAttribute('data-id');
                    deleteContact(contactId);
                });
            });
        }
        
        function updateRecipientSelect(contacts) {
            const select = document.getElementById('transfer-recipient');
            let options = '<option value="">Seleccionar contacto</option>';
            
            contacts.forEach(contact => {
                if (contact.userId) {
                    options += `<option value="${contact.userId}" data-email="${contact.email}" data-name="${contact.name}">${contact.name} (${contact.email})</option>`;
                }
            });
            
            select.innerHTML = options;
            
            // Add event listener for select change
            select.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    const email = selectedOption.getAttribute('data-email');
                    const name = selectedOption.getAttribute('data-name');
                    selectContact(this.value, email, name);
                }
            });
        }
        
        function selectContact(userId, email, name) {
            if (!userId || !email || !name) {
                showNotification('Información de contacto incompleta', 'error');
                return;
            }
            
            // Verificar que no sea el mismo usuario
            if (userId === auth.currentUser.uid) {
                showNotification('No puedes transferirte a ti mismo', 'error');
                return;
            }
            
            // Hide select, show selected recipient
            document.getElementById('select-recipient').classList.add('hidden');
            document.getElementById('selected-recipient').classList.remove('hidden');
            
            // Update display
            document.getElementById('recipient-display-name').textContent = name;
            document.getElementById('recipient-display-email').textContent = email;
            
            // Update hidden fields
            document.getElementById('recipient-id').value = userId;
            document.getElementById('recipient-email').value = email;
            document.getElementById('recipient-name').value = name;
            
            // Enable submit button
            document.getElementById('transfer-submit-button').disabled = false;
            
            showNotification(`Destinatario seleccionado: ${name}`, 'success');
        }
        
        async function deleteContact(contactId) {
            const user = auth.currentUser;
            if (!user || !contactId) return;
            
            if (confirm('¿Estás seguro de que deseas eliminar este contacto?')) {
                try {
                    await db.ref('contacts/' + user.uid + '/' + contactId).remove();
                    showNotification('Contacto eliminado', 'success');
                } catch (error) {
                    console.error('Error deleting contact:', error);
                    showNotification('Error al eliminar el contacto', 'error');
                }
            }
        }
        
        function setupEventListeners() {
            // User dropdown
            const userProfileButton = document.getElementById('user-profile-button');
            const userProfileDropdown = document.getElementById('user-profile-dropdown');
            
            userProfileButton.addEventListener('click', () => {
                userProfileDropdown.classList.toggle('active');
            });
            
            // Logout
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            // Transfer form
            const transferForm = document.getElementById('transfer-form');
            const transferAmount = document.getElementById('transfer-amount');
            const searchUserButton = document.getElementById('search-user-button');
            const addNewContactButton = document.getElementById('add-new-contact');
            const changeRecipientButton = document.getElementById('change-recipient');
            
            // Search user modal buttons
            const modalSearchButton = document.getElementById('search-user-button-modal');
            const closeSearchModal = document.getElementById('close-search-modal');
            const cancelSearch = document.getElementById('cancel-search');
            const useThisUserButton = document.getElementById('use-this-user');
            const searchModal = document.getElementById('search-user-modal');
            
            // Calculate transfer summary
            transferAmount.addEventListener('input', calculateTransferSummary);
            
            // Transfer form submission
            if (transferForm) {
                transferForm.addEventListener('submit', handleTransferSubmit);
            }
            
            // Open search modal
            searchUserButton.addEventListener('click', () => {
                searchModal.classList.add('active');
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('search-user-email').value = '';
            });
            
            // Add new contact button
            addNewContactButton.addEventListener('click', () => {
                searchModal.classList.add('active');
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('search-user-email').value = '';
            });
            
            // Change recipient button
            if (changeRecipientButton) {
                changeRecipientButton.addEventListener('click', () => {
                    document.getElementById('selected-recipient').classList.add('hidden');
                    document.getElementById('select-recipient').classList.remove('hidden');
                    document.getElementById('transfer-submit-button').disabled = true;
                });
            }
            
            // Close search modal
            closeSearchModal.addEventListener('click', () => {
                searchModal.classList.remove('active');
            });
            
            cancelSearch.addEventListener('click', () => {
                searchModal.classList.remove('active');
            });
            
            // Search user
            modalSearchButton.addEventListener('click', async () => {
                const email = document.getElementById('search-user-email').value.trim().toLowerCase();
                
                if (!email) {
                    showNotification('Por favor ingresa un correo electrónico', 'error');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showNotification('Correo electrónico inválido', 'error');
                    return;
                }
                
                // Check if searching for own email
                const currentUser = auth.currentUser;
                if (currentUser.email && currentUser.email.toLowerCase() === email) {
                    document.getElementById('search-loading').classList.add('hidden');
                    document.getElementById('user-found').classList.add('hidden');
                    document.getElementById('user-not-found').classList.remove('hidden');
                    document.getElementById('user-not-found').innerHTML = `
                        <i class="fas fa-user-slash text-3xl text-red-500 mb-3"></i>
                        <p class="text-gray-700">No puedes transferirte a ti mismo</p>
                        <p class="text-sm text-gray-600 mt-2">Por favor busca otro usuario</p>
                    `;
                    document.getElementById('search-results').classList.remove('hidden');
                    return;
                }
                
                try {
                    // Show loading
                    document.getElementById('search-results').classList.remove('hidden');
                    document.getElementById('search-loading').classList.remove('hidden');
                    document.getElementById('user-found').classList.add('hidden');
                    document.getElementById('user-not-found').classList.add('hidden');
                    
                    // Obtener todos los usuarios y buscar por email
                    const usersRef = db.ref('users');
                    const snapshot = await usersRef.once('value');
                    
                    let foundUser = null;
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        // Comparar emails en minúsculas para evitar problemas de case sensitivity
                        if (userData.email && userData.email.toLowerCase() === email) {
                            foundUser = {
                                id: childSnapshot.key,
                                name: userData.name || 'Usuario',
                                email: userData.email
                            };
                        }
                    });
                    
                    // Hide loading
                    document.getElementById('search-loading').classList.add('hidden');
                    
                    if (foundUser) {
                        document.getElementById('found-user-name').textContent = foundUser.name;
                        document.getElementById('found-user-email').textContent = foundUser.email;
                        
                        document.getElementById('user-found').classList.remove('hidden');
                        document.getElementById('user-not-found').classList.add('hidden');
                        
                        // Set up use this user button
                        useThisUserButton.onclick = () => {
                            selectContact(foundUser.id, foundUser.email, foundUser.name);
                            saveContactToDatabase(foundUser.id, foundUser.email, foundUser.name);
                            searchModal.classList.remove('active');
                        };
                    } else {
                        document.getElementById('user-found').classList.add('hidden');
                        document.getElementById('user-not-found').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error searching for user:', error);
                    document.getElementById('search-loading').classList.add('hidden');
                    showNotification('Error al buscar el usuario', 'error');
                }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!userProfileButton.contains(e.target) && !userProfileDropdown.contains(e.target)) {
                    userProfileDropdown.classList.remove('active');
                }
            });
        }
        
        function calculateTransferSummary() {
            const amount = parseFloat(this.value) || 0;
            const fee = 0.50; // Fixed fee
            const total = amount + fee;
            
            document.getElementById('transfer-summary-amount').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('transfer-summary-fee').textContent = `-$${fee.toFixed(2)}`;
            document.getElementById('transfer-summary-total').textContent = `$${total.toFixed(2)}`;
        }
        
        async function saveContactToDatabase(userId, email, name) {
            const user = auth.currentUser;
            if (!user) return;
            
            // No guardar si es el mismo usuario
            if (userId === user.uid) {
                return;
            }
            
            const contactId = 'ct_' + userId;
            const contactData = {
                name: name,
                email: email,
                userId: userId,
                type: 'personal',
                createdAt: Date.now()
            };
            
            try {
                await db.ref('contacts/' + user.uid + '/' + contactId).set(contactData);
                showNotification('Contacto agregado exitosamente', 'success');
            } catch (error) {
                console.error('Error saving contact:', error);
                // No mostrar error si el contacto ya existe
            }
        }
        
        async function handleTransferSubmit(e) {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) return;
            
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const currency = document.getElementById('transfer-currency').value;
            const recipientId = document.getElementById('recipient-id').value;
            const recipientEmail = document.getElementById('recipient-email').value;
            const recipientName = document.getElementById('recipient-name').value;
            const message = document.getElementById('transfer-message').value;
            
            // Validate inputs
            if (amount < 1) {
                showNotification('El monto mínimo es de $1', 'error');
                return;
            }
            
            if (!recipientId || !recipientEmail || !recipientName) {
                showNotification('Debes seleccionar un destinatario válido', 'error');
                return;
            }
            
            if (recipientId === user.uid) {
                showNotification('No puedes transferirte a ti mismo', 'error');
                return;
            }
            
            try {
                // First, check if we have enough balance
                const userRef = db.ref('users/' + user.uid);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                const totalDeposits = userData.totalDeposits || 0;
                const totalEarnings = userData.totalEarnings || 0;
                const referralBonus = userData.referralBonus || 0;
                const totalWithdrawals = userData.totalWithdrawals || 0;
                
                const availableBalance = totalDeposits + totalEarnings + referralBonus - totalWithdrawals;
                const totalAmount = amount + 0.50; // Amount + fee
                
                if (totalAmount > availableBalance) {
                    showNotification('Saldo insuficiente para realizar la transferencia', 'error');
                    return;
                }
                
                // Get recipient data
                const recipientRef = db.ref('users/' + recipientId);
                const recipientSnapshot = await recipientRef.once('value');
                
                if (!recipientSnapshot.exists()) {
                    showNotification('El destinatario ya no está disponible', 'error');
                    return;
                }
                
                const recipientData = recipientSnapshot.val();
                
                // Create transfer records
                const transferId = 'trf_' + Date.now();
                const now = Date.now();
                
                // Sender's transfer record
                const senderTransfer = {
                    type: 'sent',
                    amount: amount,
                    fee: 0.50,
                    total: totalAmount,
                    currency: currency,
                    recipientId: recipientId,
                    recipientEmail: recipientEmail,
                    recipientName: recipientData.name || recipientName,
                    message: message || null,
                    status: 'completed',
                    createdAt: now
                };
                
                // Recipient's transfer record
                const recipientTransfer = {
                    type: 'received',
                    amount: amount,
                    senderId: user.uid,
                    senderEmail: userData.email,
                    senderName: userData.name,
                    message: message || null,
                    status: 'completed',
                    createdAt: now
                };
                
                // Update sender's balance
                const senderUpdates = {
                    totalWithdrawals: (userData.totalWithdrawals || 0) + totalAmount,
                    updatedAt: now
                };
                
                // Update recipient's balance
                const recipientUpdates = {
                    totalDeposits: (recipientData.totalDeposits || 0) + amount,
                    updatedAt: now
                };
                
                // Create transaction records
                const senderTransaction = {
                    type: 'transfer_out',
                    amount: -totalAmount,
                    description: `Transferencia a ${recipientData.name || recipientName}`,
                    status: 'completed',
                    createdAt: now
                };
                
                const recipientTransaction = {
                    type: 'transfer_in',
                    amount: amount,
                    description: `Transferencia de ${userData.name}`,
                    status: 'completed',
                    createdAt: now
                };
                
                // Save all data atomically
                const updates = {};
                updates[`transfers/${user.uid}/${transferId}`] = senderTransfer;
                updates[`transfers/${recipientId}/${transferId}_recv`] = recipientTransfer;
                updates[`users/${user.uid}/totalWithdrawals`] = senderUpdates.totalWithdrawals;
                updates[`users/${user.uid}/updatedAt`] = now;
                updates[`users/${recipientId}/totalDeposits`] = recipientUpdates.totalDeposits;
                updates[`users/${recipientId}/updatedAt`] = now;
                updates[`transactions/${user.uid}/tx_${now}`] = senderTransaction;
                updates[`transactions/${recipientId}/tx_${now}_recv`] = recipientTransaction;
                
                // Add contact if not already exists
                const contactId = 'ct_' + recipientId;
                const contactData = {
                    name: recipientData.name || recipientName,
                    email: recipientEmail,
                    userId: recipientId,
                    type: 'personal',
                    createdAt: now
                };
                
                updates[`contacts/${user.uid}/${contactId}`] = contactData;
                
                await db.ref().update(updates);
                
                showNotification('Transferencia completada exitosamente', 'success');
                
                // Reset form
                document.getElementById('transfer-form').reset();
                document.getElementById('selected-recipient').classList.add('hidden');
                document.getElementById('select-recipient').classList.remove('hidden');
                document.getElementById('transfer-submit-button').disabled = true;
                document.getElementById('transfer-summary-amount').textContent = '$0.00';
                document.getElementById('transfer-summary-total').textContent = '$0.00';
                
            } catch (error) {
                console.error('Error processing transfer:', error);
                showNotification('Error al procesar la transferencia: ' + error.message, 'error');
            }
        }
        
        function handleLogout(e) {
            e.preventDefault();
            
            auth.signOut()
                .then(() => {
                    showNotification('Sesión cerrada correctamente', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    showNotification('Error al cerrar sesión', 'error');
                });
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications-container');
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.innerHTML = `
                <div class="notification-icon ${colors[type]} text-white rounded-lg">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button class="ml-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            notification.querySelector('button').addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }
    </script>
</body>
</html>